namespace = human_fallen_empires_brainworm

# start by civic 0
planet_event = {
	id = human_fallen_empires_brainworm.0
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		owner = {
			has_civic = human_fallen_empires_civic_brainworm
		}
	}

	immediate = {
		owner = {
			set_country_flag = custom_start_screen
		}
		random_tile = {
			limit = {
				has_pop = no
			}
			if = {
				limit = {
					has_blocker = yes
				}
				remove_blocker = yes
			}
			set_building = human_fallen_empires_brainworm_reservation_0
			create_pop = {
				species = owner
			}
			pop = {
				modify_species = {
					species = this
					remove_trait = human_fallen_empires_species_trait_brainworm
				}
			}
		}
	}
}

# functional events 1 - 50

# kick events by pop by on_pop_migration_end
# A pop has finished migrating to another planet
# Root = pop
# From = Tile on the new planet
# FromFrom = Tile on the old planet
pop_event = {
	id = human_fallen_empires_brainworm.1
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		exists = planet
		or = {
			human_fallen_empires_trigger_is_brainworm = yes
			human_fallen_empires_trigger_is_brainworm_target = yes
			planet = {
				any_owned_pop = {
					or = {
						human_fallen_empires_trigger_is_brainworm = yes
						human_fallen_empires_trigger_is_brainworm_target = yes
					}
				}
			}
		}
	}

	immediate = {
		#log = "worm migrate to [Planet.GetName]"
		if = {
			limit = {
				exists = from.owner
				exists = fromfrom.owner
				fromfrom.owner = {
					human_fallen_empires_trigger_is_brainworm_country = no
				}
				not = {
					fromfrom.owner = {
						is_country = from.owner
					}
				}
			}
			fromfrom.owner = {
				# notification for worm owner
				country_event = {
					id = human_fallen_empires_brainworm.50
				}
			}
		}
		planet = {
			# assimilate all
			planet_event = {
				id = human_fallen_empires_brainworm.4 days = 90 random = 30
			}
			# change owner if needed
			planet_event = {
				id = human_fallen_empires_brainworm.5
			}
		}
	}
}

# kick events by pop by on_pop_resettled on_pop_birth
pop_event = {
	id = human_fallen_empires_brainworm.2
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		exists = planet
		or = {
			human_fallen_empires_trigger_is_brainworm = yes
			human_fallen_empires_trigger_is_brainworm_target = yes
			planet = {
				any_owned_pop = {
					or = {
						human_fallen_empires_trigger_is_brainworm = yes
						human_fallen_empires_trigger_is_brainworm_target = yes
					}
				}
			}
		}
	}

	immediate = {
		planet = {
			# assimilate all
			planet_event = {
				id = human_fallen_empires_brainworm.4 days = 90 random = 30
			}
			# change owner if needed
			planet_event = {
				id = human_fallen_empires_brainworm.5
			}
		}
	}
}

# kick events by planet by on actions
planet_event = {
	id = human_fallen_empires_brainworm.3
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_owned_pop = {
			or = {
				human_fallen_empires_trigger_is_brainworm = yes
				human_fallen_empires_trigger_is_brainworm_target = yes
			}
		}
	}

	immediate = {
		# assimilate all
		planet_event = {
			id = human_fallen_empires_brainworm.4 
			days = 90 
			random = 30
		}
		# change owner if needed
		planet_event = {
			id = human_fallen_empires_brainworm.5
		}
	}
}

# assimilate someone on planet
planet_event = {
	id = human_fallen_empires_brainworm.4
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_owned_pop = {
			human_fallen_empires_trigger_is_brainworm_target = yes
		}
		any_owned_pop = {
			human_fallen_empires_trigger_is_brainworm = yes
		}
		exists = owner
		owner = {
			not = {
				has_policy_flag = human_fallen_empires_policies_brainworm_0.1
			}
		}
	}

	immediate = {
		owner = {
			if = {
				limit = {
					human_fallen_empires_trigger_is_brainworm_country = no
				}
				random_list = {
					90 = {
					}
					10 = {
						set_country_flag = human_fallen_empires_brainworm_discovered
						# notification for owner
						country_event = {
							id = human_fallen_empires_brainworm.51
						}
						# notification for brainworms
						every_country = {
							limit = {
								human_fallen_empires_trigger_is_brainworm_country = yes
							}
							country_event = {
								id = human_fallen_empires_brainworm.52
							}
						}
					}
				}
			}
		}
		random_owned_pop = {
			limit = {
				human_fallen_empires_trigger_is_brainworm_target = yes
				exists = tile
				tile = {
					nor = {
						has_building = human_fallen_empires_brainworm_reservation_0
						has_building = human_fallen_empires_brainworm_reservation_1
					}
				}
			}
			modify_species = {
				species = this
				add_trait = human_fallen_empires_species_trait_brainworm
			}
			if = {
				limit = {
					has_trait = trait_hive_mind
				}
				modify_species = {
					species = this
					remove_trait = trait_hive_mind
				}
			}
		}
		# assimilate again
		planet_event = {
			id = human_fallen_empires_brainworm.4
			days = 90
			random = 60
		}
		# change owner again
		planet_event = {
			id = human_fallen_empires_brainworm.5
			days = 1
		}
	}
}

# add planet to brainworm empire
planet_event = {
	id = human_fallen_empires_brainworm.5
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		exists = owner
		owner = {
			human_fallen_empires_trigger_is_brainworm_country = no
			not = {
				is_country_type = human_fallen_empires_pirate
			}
		}
		any_owned_pop = {
			human_fallen_empires_trigger_is_brainworm = yes
		}
		pop_percentage = {
			percentage > 0.8
			limit = {
				or = {
					human_fallen_empires_trigger_is_brainworm = yes
					is_non_menial_laborer = yes
				}
			}
		}
	}

	immediate = {
		log = "worm gain planet [This.GetName]"
		if = {
			limit = {
				any_playable_country = {
					human_fallen_empires_trigger_is_brainworm_country = yes
				}
			}
			random_playable_country = {
				limit = {
					human_fallen_empires_trigger_is_brainworm_country = yes
				}
				save_event_target_as = human_fallen_empires_brainworm_country
			}
			else = {
				random_owned_pop = {
					limit = {
						has_trait = human_fallen_empires_species_trait_brainworm
					}
					create_country = {
						name = random
						type = default
						species = prev
						name_list = random
						flag = random
						effect = {
							save_event_target_as = human_fallen_empires_brainworm_country
						}
					}
				}
			}
		}
		# notification for old owner
		planet_event = {
			id = human_fallen_empires_brainworm.53
		}
		set_owner = event_target:human_fallen_empires_brainworm_country
		set_controller = event_target:human_fallen_empires_brainworm_country
		# notification for new owner
		planet_event = {
			id = human_fallen_empires_brainworm.54
		}
	}
}

# change leader species
country_event = {
	id = human_fallen_empires_brainworm.6
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		human_fallen_empires_trigger_is_brainworm_country = yes
		exists = from.species
		from.species = {
			human_fallen_empires_trigger_is_brainworm_country = no
		}
	}

	immediate = {
		from = {
			change_species = root.species
		}
	}
}

# notifications 50 - 100

# pop migrated 50
country_event = {
	id = human_fallen_empires_brainworm.50
	title = human_fallen_empires_brainworm.50.name
	desc = human_fallen_empires_brainworm.50.desc
	picture = GFX_evt_human_fallen_empires_brainworm
	location = from
    is_triggered_only = yes

	trigger = {
		is_ai = no
	}

	option = {
		name = human_fallen_empires_brainworm.50.0
	}
}

# know brain worm 51
country_event = {
	id = human_fallen_empires_brainworm.51
	title = human_fallen_empires_brainworm.51.name
	desc = human_fallen_empires_brainworm.51.desc
	picture = GFX_evt_human_fallen_empires_brainworm
	location = from
    is_triggered_only = yes

	trigger = {
		is_ai = no
	}

	option = {
		name = human_fallen_empires_brainworm.51.0
	}
}

# know brain worm notification for worms 52
country_event = {
	id = human_fallen_empires_brainworm.52
	title = human_fallen_empires_brainworm.52.name
	desc = human_fallen_empires_brainworm.52.desc
	picture = GFX_evt_human_fallen_empires_brainworm
	location = from
    is_triggered_only = yes

	trigger = {
		is_ai = no
	}

	option = {
		name = human_fallen_empires_brainworm.52.0
	}
}

# planet lose 53
planet_event = {
	id = human_fallen_empires_brainworm.53
	title = human_fallen_empires_brainworm.53.name
	desc = human_fallen_empires_brainworm.53.desc
	picture = GFX_evt_human_fallen_empires_brainworm
	location = root
    is_triggered_only = yes

	trigger = {
		exists = owner
		owner = {
			is_ai = no
		}
	}

	option = {
		name = human_fallen_empires_brainworm.53.0
	}
}

# planet gain 54
planet_event = {
	id = human_fallen_empires_brainworm.54
	title = human_fallen_empires_brainworm.54.name
	desc = human_fallen_empires_brainworm.54.desc
	picture = GFX_evt_human_fallen_empires_brainworm
	location = root
    is_triggered_only = yes

	trigger = {
		exists = owner
	}

	option = {
		name = human_fallen_empires_brainworm.54.0
		owner = {
			human_fallen_empires_effect_add_unity.1 = yes
		}
	}
}

# secondary species: assign trait_machine_unit, turn into robotics, then create pops
# this: capital planet
# from: secondary species
planet_event = {
	id = human_fallen_empires_brainworm.100
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		owner = {
			has_civic = human_fallen_empires_civic_brainworm_syncretic
		}
	}


	immediate = {
		from = {
			save_event_target_as = secondary_species
		}
		event_target:secondary_species = {
			set_citizenship_type = {
				country = root.owner
				type = citizenship_slavery
			}
		}
		while = {
			count = 4
			random_tile = {
				limit = {
					OR = {
						has_building = building_mining_network_1
						has_building = building_hydroponics_farm_1
					}
					has_pop = no
				}
				create_pop = {
					species = event_target:secondary_species
				}
			}
		}
	}
}
