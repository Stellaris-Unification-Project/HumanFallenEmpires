#
namespace = human_fallen_empires_maintenance

# This = Ship
# From = Disabler Ship
# kill starbases of drone on_ship_disabled
ship_event = {
	id = human_fallen_empires_maintenance.0
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		exists = this
		exists = owner
		owner = {
			is_country_type = human_fallen_empires_drone
		}
		is_ship_class = shipclass_starbase
	}

	immediate = {
		owner = {
			every_owned_planet = {
				limit = {
					solar_system = {
						is_same_value = root.solar_system
					}
				}
				human_fallen_empires_effect_convert_to_asteroid = yes
			}
		}
		log = "drone loss starbase on [root.solar_system.GetName] killer [root.from.owner.GetName]"
		fleet = {
			destroy_fleet = this
		}
	}
}

# log drone outpost
ship_event = {
	id = human_fallen_empires_maintenance.1
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		always = no
		exists = owner
		owner = {
			or = {
				is_country_type = human_fallen_empires_drone
				is_country_type = human_fallen_empires_pirate
			}
		}
	}

	immediate = {
		log = "outpost build in [root.solar_system.GetName] by [root.owner.GetName]"
	}
}

#
planet_event = {
	id = human_fallen_empires_maintenance.2
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		exists = owner
		owner = {
			is_country_type = human_fallen_empires_drone
		}
	}

	immediate = {
		human_fallen_empires_effect_convert_to_asteroid = yes
	}
}

# building_assimilator feature
# on_purge_complete
planet_event = {
	id = human_fallen_empires_maintenance.10
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_owned_pop = {
			has_pop_flag = human_fallen_empires_building_assimilator
			is_being_force_purged = yes
			human_fallen_empires_trigger_building_assimilator_with_tile = yes
		}
	}

	immediate = {
		owner = {
			human_fallen_empires_effect_add_unity.1 = yes
			human_fallen_empires_effect_add_society_research.2 = yes
		}
	}
}

# on_pop_migration_end on_pop_moved on_pop_resettled
pop_event = {
	id = human_fallen_empires_maintenance.11
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		human_fallen_empires_trigger_building_assimilator_with_tile = yes
	}

	immediate = {
		set_pop_flag = human_fallen_empires_building_assimilator
		purge = yes
	}
}

# on_pop_migration_end on_pop_moved on_pop_resettled
pop_event = {
	id = human_fallen_empires_maintenance.12
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_pop_flag = human_fallen_empires_building_assimilator
		is_being_force_purged = yes
		human_fallen_empires_trigger_building_assimilator_with_tile = no
	}

	immediate = {
		remove_pop_flag = human_fallen_empires_building_assimilator
		purge = no
	}
}

planet_event = {
	id = human_fallen_empires_maintenance.13
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_owned_pop = {
			pop_event = {
				id = human_fallen_empires_maintenance.12
			}
		}
	}
}

# fix psi traits
country_event = {
	id = human_fallen_empires_maintenance.50
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_owned_pop = {
			limit = {
				has_trait = trait_latent_psionic
				has_trait = trait_psionic
			}
			modify_species = {
				species = this
				remove_trait = trait_latent_psionic
			}
		}
	}
}