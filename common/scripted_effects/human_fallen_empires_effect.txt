#

# for country/planet
human_fallen_empires_effect_refugee_10 = {
	every_owned_pop = {
		random_list = {
			90 = {
			}
			10 = {
				human_fallen_empires_effect_refugee_or_die = yes
			}
		}
	}
}

# for pop
human_fallen_empires_effect_refugee_or_die = {
	save_event_target_as = human_fallen_empires_refugee_pop_target
	if = {
		limit = {
			is_robot_pop = no
			nor = {
				has_trait = trait_hive_mind
				has_trait = trait_nerve_stapled
			}
			owner = {
				any_relation = {
					#is_country_type = default
					not = {
						has_policy_flag = refugees_not_allowed
					}
					event_target:human_fallen_empires_refugee_pop_target = {
						OR = {
							has_citizenship_type = {
								type = citizenship_full
								country = prev
							}
							has_citizenship_type = {
								type = citizenship_caste_system
								country = prev
							}
							AND = {
								has_citizenship_type = {
									type = citizenship_limited
									country = prev
								}
								has_citizenship_type = {
									type = citizenship_caste_system_limited
									country = prev
								}
								prev = {
									has_policy_flag = refugees_allowed
								}
							}
						}
					}
					any_owned_planet = {
						habitability = {
							who = event_target:human_fallen_empires_refugee_pop_target
							value > 0.2
						}
						human_fallen_empires_trigger_planet_valid_for_settle = yes
					}
				}
			}
		}
		remove_modifier = pop_recently_conquered
		add_modifier = {
			modifier = recent_refugee
			days = 3600
		}
		save_event_target_as = human_fallen_empires_settle_pop_target
		owner = {
			random_relation = {
				limit = {
					#is_country_type = default
					not = {
						has_policy_flag = refugees_not_allowed
					}
					event_target:human_fallen_empires_refugee_pop_target = {
						OR = {
							has_citizenship_type = {
								type = citizenship_full
								country = prev
							}
							has_citizenship_type = {
								type = citizenship_caste_system
								country = prev
							}
							AND = {
								has_citizenship_type = {
									type = citizenship_limited
									country = prev
								}
								has_citizenship_type = {
									type = citizenship_caste_system_limited
									country = prev
								}
								prev = {
									has_policy_flag = refugees_allowed
								}
							}
						}
					}
					any_owned_planet = {
						habitability = {
							who = event_target:human_fallen_empires_refugee_pop_target
							value > 0.2
						}
						human_fallen_empires_trigger_planet_valid_for_settle = yes

					}
				}
				human_fallen_empires_effect_settle_pop = yes
			}
		}
		else = {
			kill_pop = yes
		}
	}
}

# for country need human_fallen_empires_settle_pop_target
human_fallen_empires_effect_settle_pop = {
	if = {
		limit = {
			not = {
				any_owned_planet = {
					human_fallen_empires_trigger_planet_valid_for_settle = yes
				}
			}
		}
		event_target:human_fallen_empires_settle_pop_target = {
			human_fallen_empires_effect_refugee_or_die = yes
		}
		else = {
			if = {
				limit = {
					any_owned_planet = {
						habitability = {
							who = event_target:human_fallen_empires_settle_pop_target
							value > 0.4
						}
						human_fallen_empires_trigger_planet_valid_for_settle = yes
					}
				}
				random_owned_planet = {
					limit = {
						habitability = {
							who = event_target:human_fallen_empires_settle_pop_target
							value > 0.4
						}
						free_pop_tiles > 0
					}
					resettle_pop = {
						pop = event_target:human_fallen_empires_settle_pop_target
						planet = this
					}
					add_organic_sanctuaries = yes
				}
				else = {
					random_owned_planet = {
						limit = {
							human_fallen_empires_trigger_planet_valid_for_settle = yes
						}
						resettle_pop = {
							pop = event_target:human_fallen_empires_settle_pop_target
							planet = this
						}
						add_organic_sanctuaries = yes
					}
				}
			}
		}
	}
}

# for country need human_fallen_empires_settle_pop_target
human_fallen_empires_effect_settle_pop_from_slavery_buff = {
	event_target:human_fallen_empires_settle_pop_target = {
		if = {
			limit = {
				or = {
					is_same_species = owner
					has_citizenship_type = {
						country = owner
						type = citizenship_full
					}
					has_citizenship_type = {
						country = owner
						type = citizenship_limited
					}
				}
			}
			add_modifier = {
				modifier = pop_saved_from_slavery
				days = 3650
			}
			else = {
				add_modifier = {
					modifier = human_fallen_empires_pirate_pop_purchased
					days = 3650
				}
			}
		}
	}
}

# for pop
human_fallen_empires_effect_add_random_trait = {
	random_list = {
		1 = {
			modifier = {
				factor = 0
				has_trait = human_fallen_empires_species_trait_hucksters
			}
			modify_species = {
				species = this
				add_trait = human_fallen_empires_species_trait_hucksters
			}
		}
		1 = {
			modifier = {
				factor = 0
				has_trait = human_fallen_empires_species_trait_war_fans
			}
			modify_species = {
				species = this
				add_trait = human_fallen_empires_species_trait_war_fans
			}
		}
		1 = {
			modifier = {
				factor = 0
				has_trait = human_fallen_empires_species_trait_error
			}
			modify_species = {
				species = this
				add_trait = human_fallen_empires_species_trait_error
			}
		}
		1 = {
			modifier = {
				factor = 0
				has_trait = human_fallen_empires_species_trait_happy_slave
			}
			modify_species = {
				species = this
				add_trait = human_fallen_empires_species_trait_happy_slave
			}
		}
		1 = {
			modifier = {
				factor = 0
				has_trait = human_fallen_empires_species_trait_clever_beast
			}
			modify_species = {
				species = this
				add_trait = human_fallen_empires_species_trait_clever_beast
			}
		}
	}
}

# varelse fleen event
# for fleet
human_fallen_empires_effect_varelse_fleet_attack_home_of_light = {
	set_fleet_stance = aggressive
	clear_fleet_actions = this
	queue_actions = {
		find_closest_system = {
			trigger = {
				id = human_fallen_empires_effect_varelse_fleet_attack_home_of_light_trigger.0
				any_planet = {
					has_planet_flag = human_fallen_empires_home_of_light
				}
			}
			found_system = {
				move_to = this
				effect = {
					id = human_fallen_empires_effect_varelse_fleet_attack_home_of_light_effect.1
					if = {
						limit = {
							any_planet = {
								has_planet_flag = human_fallen_empires_home_of_light
								not = {
									and = {
										exists = owner
										owner = {
											has_country_flag = human_fallen_empires_egypt
										}
									}
								}
							}
						}
						event_target:human_fallen_empires_varelse_fleet = {
							human_fallen_empires_effect_varelse_fleet_find_new_home = yes
						}
						else = {
							event_target:human_fallen_empires_varelse_fleet = {
								owner = {
									set_faction_hostility = {
										set_hostile = yes
									}
								}
							}
						}
					}
				}
				find_closest_planet = {
					trigger = {
						id = human_fallen_empires_effect_varelse_fleet_attack_home_of_light_trigger.1
						has_planet_flag = human_fallen_empires_home_of_light
					}
					found_planet = {
						move_to = this
						repeat = {
							while = {
								id = human_fallen_empires.53.attact_trigger.2
								num_pops > 0
							}
							wait = {
								duration = 60
							}
						}
						effect = {
							id = human_fallen_empires_effect_varelse_fleet_attack_home_of_light_effect.2
							event_target:human_fallen_empires_varelse_fleet = {
								clear_fleet_actions = this
								human_fallen_empires_effect_varelse_fleet_find_new_home = yes
							}
						}
					}
				}
			}
			failed = {
				wait = 100
				effect = {
					id = human_fallen_empires_effect_varelse_fleet_attack_home_of_light_effect.3
					event_target:human_fallen_empires_varelse_fleet = {
						clear_fleet_actions = this
						human_fallen_empires_effect_varelse_fleet_find_new_home = yes
					}
				}
			}
		}
	}
}

human_fallen_empires_effect_varelse_fleet_find_new_home = {
	clear_fleet_actions = this
	queue_actions = {
		find_closest_system = {
			trigger = {
				id = human_fallen_empires_find_new_home_trigger.0
				any_planet = {
					has_owner = no
					habitability = {
						who = event_target:human_fallen_empires_varelse_species
						value > 0.7
					}
				}
			}
			found_system = {
				move_to = this
			}
			failed = {
				find_closest_system = {
					trigger = {
						id = human_fallen_empires_find_new_home_trigger.1
						any_planet = {
							has_owner = no
							habitability = {
								who = event_target:human_fallen_empires_varelse_species
								value > 0.4
							}
						}
					}
					found_system = {
						move_to = this
					}
					failed = {
						find_closest_system = {
							trigger = {
								id = human_fallen_empires_find_new_home_trigger.2
								any_planet = {
									has_owner = no
									habitability = {
										who = event_target:human_fallen_empires_varelse_species
										value > 0.1
									}
								}
							}
							found_system = {
								move_to = this
							}
							failed = {
								wait = 100
								effect = {
									id = human_fallen_empires_find_new_home_effect.0
									human_fallen_empires_effect_varelse_fleet_attack_home_of_light = yes
								}
							}
						}
					}
				}
			}
		}
		find_closest_planet = {
			trigger = {
				id = human_fallen_empires_find_new_home_trigger.3
				has_owner = no
				habitability = {
					who = event_target:human_fallen_empires_varelse_species
					value > 0.7
				}
			}
			found_planet = {
				move_to = this
				effect = {
					id = human_fallen_empires_find_new_home_effect.1
					human_fallen_empires_effect_varelse_fleet_find_new_home_colony = yes
				}
			}
			failed = {
				find_closest_planet = {
					trigger = {
						id = human_fallen_empires_find_new_home_trigger.4
						has_owner = no
						habitability = {
							who = event_target:human_fallen_empires_varelse_species
							value > 0.4
						}
					}
					found_planet = {
						move_to = this
						effect = {
							id = human_fallen_empires_find_new_home_effect.2
							human_fallen_empires_effect_varelse_fleet_find_new_home_colony = yes
						}
					}
					failed = {
						find_closest_planet = {
							trigger = {
								id = human_fallen_empires_find_new_home_trigger.5
								has_owner = no
								habitability = {
									who = event_target:human_fallen_empires_varelse_species
									value > 0.1
								}
							}
							found_planet = {
								move_to = this
								effect = {
									id = human_fallen_empires_find_new_home_effect.3
									human_fallen_empires_effect_varelse_fleet_find_new_home_colony = yes
								}
							}
						}
					}
				}
			}
		}
	}
}

human_fallen_empires_effect_varelse_fleet_find_new_home_colony = {
	create_country = {
		name = "Varelse Hegemony"
		type = default
		authority = random
		civics = random
		species = event_target:human_fallen_empires_varelse_species
		ethos = {
			ethic = ethic_xenophobe
			ethic = ethic_militarist
			ethic = ethic_materialist
		}
		flag = random
	}
	create_colony = {
		owner = last_created_country
		species = owner
	}
	event_target:human_fallen_empires_varelse_fleet = {
		set_owner = last_created_country
	}
}

# for country return 6 event targets
human_fallen_empires_effect_save_event_target = {
	if = {
		limit = {
			not = {
				exists = event_target:human_fallen_empires_event_target_0
			}
		}
		save_event_target_as = human_fallen_empires_event_target_0
		else = {
			if = {
				limit = {
					nor = {
						is_same_value = event_target:human_fallen_empires_event_target_0
						exists = event_target:human_fallen_empires_event_target_1
					}
				}
				save_event_target_as = human_fallen_empires_event_target_1
				else = {
					if = {
						limit = {
							nor = {
								is_same_value = event_target:human_fallen_empires_event_target_0
								is_same_value = event_target:human_fallen_empires_event_target_1
								exists = event_target:human_fallen_empires_event_target_2
							}
						}
						save_event_target_as = human_fallen_empires_event_target_2
						else = {
							if = {
								limit = {
									nor = {
										is_same_value = event_target:human_fallen_empires_event_target_0
										is_same_value = event_target:human_fallen_empires_event_target_1
										is_same_value = event_target:human_fallen_empires_event_target_2
										exists = event_target:human_fallen_empires_event_target_3
									}
								}
								save_event_target_as = human_fallen_empires_event_target_3
								else = {
									if = {
										limit = {
											nor = {
												is_same_value = event_target:human_fallen_empires_event_target_0
												is_same_value = event_target:human_fallen_empires_event_target_1
												is_same_value = event_target:human_fallen_empires_event_target_2
												is_same_value = event_target:human_fallen_empires_event_target_3
												exists = event_target:human_fallen_empires_event_target_4
											}
										}
										save_event_target_as = human_fallen_empires_event_target_4
										else = {
											if = {
												limit = {
													nor = {
														is_same_value = event_target:human_fallen_empires_event_target_0
														is_same_value = event_target:human_fallen_empires_event_target_1
														is_same_value = event_target:human_fallen_empires_event_target_2
														is_same_value = event_target:human_fallen_empires_event_target_3
														is_same_value = event_target:human_fallen_empires_event_target_4
														exists = event_target:human_fallen_empires_event_target_5
													}
												}
												save_event_target_as = human_fallen_empires_event_target_5
											}
										}
									}
								}
							}
						}
					}
				}
			}
		}
	}
}

human_fallen_empires_effect_clear_event_target = {
	clear_global_event_target = human_fallen_empires_event_target_0
	clear_global_event_target = human_fallen_empires_event_target_1
	clear_global_event_target = human_fallen_empires_event_target_2
	clear_global_event_target = human_fallen_empires_event_target_3
	clear_global_event_target = human_fallen_empires_event_target_4
	clear_global_event_target = human_fallen_empires_event_target_5
}

human_fallen_empires_effect_create_egypt_fleet = {
	event_target:human_fallen_empires_egypt_country = {
		create_leader = {
			type = admiral
			species = event_target:human_fallen_empires_egypt_species
			name = random
			skill = 5
			leader_age_min = 150
			leader_age_max = 650
			traits = {
				trait = random_trait
				trait = random_trait
			}
		}
	}
	create_fleet = {
		effect = {
			set_owner = event_target:human_fallen_empires_egypt_country
			while = {
				count = 18
				create_ship = {
					name = random
					random_existing_design = battleship
				}
			}
			assign_leader = last_created_leader
			while = {
				count = 32
				create_ship = {
					name = random
					random_existing_design = corvette
				}
			}
			set_location = {
				target = event_target:human_fallen_empires_egypt_country.capital_scope
				distance = 90
				angle = random
			}
		}
	}
}

human_fallen_empires_effect_create_future_fleet = {
	event_target:human_fallen_empires_future_country = {
		create_leader = {
			type = admiral
			species = event_target:human_fallen_empires_future_species
			name = random
			skill = 5
			leader_age_min = 40
			traits = {
				trait = random_trait
				trait = random_trait
			}
		}
	}
	create_fleet = {
		effect = {
			set_owner = event_target:human_fallen_empires_future_country
			while = {
				count = 20
				create_ship = {
					name = random
					random_existing_design = battleship
				}
			}
			assign_leader = last_created_leader
			while = {
				count = 60
				create_ship = {
					name = random
					random_existing_design = corvette
				}
			}
			set_location = {
				target = event_target:human_fallen_empires_future_country.capital_scope
				distance = 90
				angle = random
			}
		}
	}
}

# for leader
human_fallen_empires_effect_add_psionic_trait = {
	if = {
		limit = {
			nor = {
				has_trait = leader_trait_admiral_psionic
				has_trait = leader_trait_general_psionic
				has_trait = leader_trait_governor_psionic
				has_trait = leader_trait_scientist_psionic
				has_trait = leader_trait_ruler_psionic
				has_trait = leader_trait_admiral_chosen
				has_trait = leader_trait_general_chosen
				has_trait = leader_trait_governor_chosen
				has_trait = leader_trait_scientist_chosen
				has_trait = leader_trait_ruler_chosen
			}
		}
		switch = {
			trigger = leader_class
			admiral = {
				add_trait = leader_trait_admiral_psionic
				add_ruler_trait = leader_trait_ruler_psionic
			}
			general = {
				add_trait = leader_trait_general_psionic
				add_ruler_trait = leader_trait_ruler_psionic
			}
			governor = {
				add_trait = leader_trait_governor_psionic
				add_ruler_trait = leader_trait_ruler_psionic
			}
			scientist = {
				add_trait = leader_trait_scientist_psionic
				add_ruler_trait = leader_trait_ruler_psionic
			}
			ruler = {
				add_trait = leader_trait_ruler_psionic
			}
		}
	}
}

# for system
human_fallen_empires_effect_create_starbase = {
	if = {
		limit = {
			exists = starbase
		}
		starbase = {
			set_owner = event_target:human_fallen_empires_starbase_owner
		}
		else = {
			create_starbase = {
				size = starbase_outpost
				#module = shipyard
				owner = event_target:human_fallen_empires_starbase_owner
			}
		}
	}
}

# for planet
human_fallen_empires_effect_create_starbase_outpost_from_planet = {
	owner = {
		save_event_target_as = human_fallen_empires_starbase_owner
	}
	solar_system = {
		human_fallen_empires_effect_create_starbase = yes
	}
}

human_fallen_empires_effect_create_starbase_starport_from_planet = {
	owner = {
		save_event_target_as = human_fallen_empires_starbase_owner
	}
	solar_system = {
		human_fallen_empires_effect_create_starbase = yes
		starbase = {
			set_starbase_size = starbase_starport
		}
	}
}

human_fallen_empires_effect_create_starbase_starhold_from_planet = {
	owner = {
		save_event_target_as = human_fallen_empires_starbase_owner
	}
	solar_system = {
		human_fallen_empires_effect_create_starbase = yes
		starbase = {
			set_starbase_size = starbase_starhold
		}
	}
}

human_fallen_empires_effect_create_starbase_starfortress_from_planet = {
	owner = {
		save_event_target_as = human_fallen_empires_starbase_owner
	}
	solar_system = {
		human_fallen_empires_effect_create_starbase = yes
		starbase = {
			set_starbase_size = starbase_starfortress
		}
	}
}

human_fallen_empires_effect_create_starbase_citadel_from_planet = {
	owner = {
		save_event_target_as = human_fallen_empires_starbase_owner
	}
	solar_system = {
		human_fallen_empires_effect_create_starbase = yes
		starbase = {
			set_starbase_size = starbase_citadel
		}
	}
}

# for starbase
human_fallen_empires_effect_create_starbase_upgrade = {
	owner = {
		switch = {
			trigger = has_technology
			tech_starbase_5 = {
				prev = {
					set_starbase_size = starbase_citadel
				}
			}
			tech_starbase_4 = {
				prev = {
					set_starbase_size = starbase_starfortress
				}
			}
			tech_starbase_3 = {
				prev = {
					set_starbase_size = starbase_starhold
				}
			}
			tech_starbase_2 = {
				prev = {
					set_starbase_size = starbase_starport
				}
			}
		}
	}
}
