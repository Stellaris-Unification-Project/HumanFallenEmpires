# pirate

# for country
human_fallen_empires_effect_pirate_diplomacy_remove_flags = {
	remove_country_flag = human_fallen_empires_pirate.101.raid_menu
	remove_country_flag = human_fallen_empires_pirate.101.traid_menu
	remove_country_flag = human_fallen_empires_pirate.101.deal_offer
	remove_country_flag = human_fallen_empires_pirate.101.slave_menu
	remove_country_flag = human_fallen_empires_pirate.101.service_menu
	remove_country_flag = human_fallen_empires_pirate.101.psi_test_menu
	remove_country_flag = human_fallen_empires_pirate.101.casino_menu
	remove_country_flag = human_fallen_empires_pirate.101.casino_menu.challenge
}

# create pirate
# return event target pirate_band, need event target human_fallen_empires_pirate_target
human_fallen_empires_effect_pirate_init = {
	event_target:human_fallen_empires_pirate_target = {
		set_timed_country_flag = {
			flag = human_fallen_empires_pirate_spawned
			days = @human_fallen_empires_pirate_spawn_cooldown
		}
		random_system = {
			limit = {
				distance_to_empire = {
					who = event_target:human_fallen_empires_pirate_target
					distance <= 150
				}
				human_fallen_empires_trigger_pirate_valid_base_system = yes
			}
			# for vanilla localization
			save_event_target_as = pirate_system
			human_fallen_empires_effect_pirate_init_country = yes
			human_fallen_empires_effect_pirate_init_base = yes
		}
		if = {
			limit = {
				not = {
					has_event_chain = human_fallen_empires_chain_pirate_count
				}
			}
			begin_event_chain = {
				event_chain = human_fallen_empires_chain_pirate_count
				target = this
			}
			set_country_flag = human_fallen_empires_birth_of_piracy
			set_country_flag = pirate_encountered
			set_country_flag = birth_of_piracy
			country_event = {
				id = human_fallen_empires_pirate.1
				days = 1
				random = 15
			}
		}
		else = {
			country_event = {
				id = human_fallen_empires_pirate.7
				days = 1
				random = 15
			}
		}
	}
}

# for system, asteroid ideally, need event target pirate_band
human_fallen_empires_effect_pirate_init_base = {
	random_system_planet = {
		limit = {
			human_fallen_empires_trigger_pirate_valid_base_planet = yes
		}
		weights = {
			base = 10
			modifier = {
				mult = 100
				exists = orbital_deposit_tile
				orbital_deposit_tile = {
					has_deposit = no
				}
			}
		}
		change_pc = human_fallen_empires_pc_pirate_base
		# if = {
		# 	limit = {
		# 		not = {
		# 			is_planet_class = human_fallen_empires_pc_pirate_base
		# 		}
		# 	}
		# 	log = "wrong planet class while init pirate base [this.GetName] system: [solar_system.GetName]"
		# }
		create_colony = {
			owner = event_target:human_fallen_empires_pirate_clan
		}
		every_owned_pop = {
			kill_pop = yes
		}
		#set_owner = event_target:human_fallen_empires_pirate_clan
		# if = {
		# 	 limit = {
		# 		 not = {
		# 			 exists = owner
		# 		 }
		# 	 }
		# 	 #set_owner = event_target:human_fallen_empires_pirate_clan
		# 	 log = "owner not exists [this.GetName] system: [solar_system.GetName]"
		# }
		#log = "pirate created new base [this.GetName] in [solar_system.GetName] system, owner: [owner.GetName]"
		#set_planet_flag = human_fallen_empires_pirate_base
		human_fallen_empires_effect_create_starbase_starport_from_planet = yes
		human_fallen_empires_effect_starbase_add_shipyard_0 = yes
	}
}

human_fallen_empires_effect_pirate_init_country = {
	create_country = {
		type = human_fallen_empires_pirate
		species = event_target:human_fallen_empires_pirate_target
		name_list = human_fallen_empires_namelist_pirate
		released_from_country = event_target:human_fallen_empires_pirate_target
		ignore_initial_colony_error = yes
		effect = {
			human_fallen_empires_effect_gov_fix = yes
			change_country_flag = {
				icon = {
					category = zoological
					file = flag_zoological_1.dds
				}
				background= {
					category = backgrounds
					file = 00_solid.dds
				}
				colors = {
					dark_grey
					dark_grey
					null
					null
				}
			}
			randomize_flag_symbol = pirate
			add_modifier = {
				modifier = human_fallen_empires_pirate_country_unkeep
			}
			random_list = {
				10 = {
					set_graphical_culture = human_fallen_empires_graphical_culture_pirate
				}
				10 = {
					set_graphical_culture = human_fallen_empires_graphical_culture_pirate_full_color
				}
				10 = {
					set_graphical_culture = human_fallen_empires_graphical_culture_pirate_full_color_2
				}
				10 = {
					set_graphical_culture = human_fallen_empires_graphical_culture_pirate_full_color_3
				}
				10 = {
					set_graphical_culture = human_fallen_empires_graphical_culture_pirate_full_color_4
				}
				10 = {
					set_graphical_culture = human_fallen_empires_graphical_culture_pirate_full_color_5
				}
			}
			give_technology = {
				tech = tech_sensors_2
				message = no
			}
			add_energy = 500
			if = {
				limit = {
					years_passed > 60
				}
				add_minerals = 10000
				add_modifier = {
					modifier = human_fallen_empires_pirate_country_boost
					days = 3650
				}
			}
			else_if = {
				limit = {
					years_passed > 40
				}
				add_minerals = 5000
				add_modifier = {
					modifier = human_fallen_empires_pirate_country_boost
					days = 1825
				}
			}
			else = {
				add_minerals = 1000
				add_modifier = {
					modifier = human_fallen_empires_pirate_country_boost
					days = 365
				}
			}
			set_relation_flag = {
				who = event_target:human_fallen_empires_pirate_target
				flag = pirate_relation
			}
			if = {
				limit = {
					has_ethic = ethic_pacifist
				}
				country_remove_ethic = ethic_pacifist
				country_add_ethic = ethic_militarist
			}
			else_if = {
				limit = {
					has_ethic = ethic_fanatic_pacifist
				}
				country_remove_ethic = ethic_fanatic_pacifist
				country_add_ethic = ethic_fanatic_militarist
			}
			save_event_target_as = human_fallen_empires_pirate_clan
			# for vanilla localization
			save_event_target_as = pirate_band
			every_country = {
				limit = {
					is_country_type = primitive
				}
				establish_communications_no_message = prev
				prev = {
					if = {
						limit = {
							is_xenophobe = no
						}
					}
					set_faction_hostility = {
						target = prev
						set_hostile = no
						set_neutral = yes
						set_friendly = no
					}
				}
			}
			every_country = {
				limit = {
					is_country_type = enclave
				}
				set_faction_hostility = {
					target = prev
					set_hostile = no
					set_neutral = yes
					set_friendly = no
				}
			}
			while = {
				count = 4
				create_leader = {
					type = scientist
				}
			}
			create_leader = {
				type = admiral
			}
			create_leader = {
				type = ruler
			}
			assign_leader = last_created_leader
			event_target:human_fallen_empires_pirate_target = {
				if = {
					limit = {
						has_event_chain = human_fallen_empires_chain_pirate_count
					}
					add_event_chain_counter = {
						event_chain = human_fallen_empires_chain_pirate_count
						counter = human_fallen_empires_chain_pirate_count_clan
						amount = 1
					}
				}
			}
		}
	}
}

# for country, return 6 event targets of not same species
human_fallen_empires_effect_save_slave_target = {
	every_owned_pop = {
		if = {
			limit = {
				exists = event_target:human_fallen_empires_slave_target_5
			}
		}
		else_if = {
			limit = {
				not = {
					exists = event_target:human_fallen_empires_slave_target_0
				}
			}
			save_event_target_as = human_fallen_empires_slave_target_0
		}
		else_if = {
			limit = {
				nor = {
					is_exact_same_species = event_target:human_fallen_empires_slave_target_0
					exists = event_target:human_fallen_empires_slave_target_1
				}
			}
			save_event_target_as = human_fallen_empires_slave_target_1
		}
		else_if = {
			limit = {
				nor = {
					is_exact_same_species = event_target:human_fallen_empires_slave_target_0
					is_exact_same_species = event_target:human_fallen_empires_slave_target_1
					exists = event_target:human_fallen_empires_slave_target_2
				}
			}
			save_event_target_as = human_fallen_empires_slave_target_2
		}
		else_if = {
			limit = {
				nor = {
					is_exact_same_species = event_target:human_fallen_empires_slave_target_0
					is_exact_same_species = event_target:human_fallen_empires_slave_target_1
					is_exact_same_species = event_target:human_fallen_empires_slave_target_2
					exists = event_target:human_fallen_empires_slave_target_3
				}
			}
			save_event_target_as = human_fallen_empires_slave_target_3
		}
		else_if = {
			limit = {
				nor = {
					is_exact_same_species = event_target:human_fallen_empires_slave_target_0
					is_exact_same_species = event_target:human_fallen_empires_slave_target_1
					is_exact_same_species = event_target:human_fallen_empires_slave_target_2
					is_exact_same_species = event_target:human_fallen_empires_slave_target_3
					exists = event_target:human_fallen_empires_slave_target_4
				}
			}
			save_event_target_as = human_fallen_empires_slave_target_4
		}
		else_if = {
			limit = {
				nor = {
					is_exact_same_species = event_target:human_fallen_empires_slave_target_0
					is_exact_same_species = event_target:human_fallen_empires_slave_target_1
					is_exact_same_species = event_target:human_fallen_empires_slave_target_2
					is_exact_same_species = event_target:human_fallen_empires_slave_target_3
					is_exact_same_species = event_target:human_fallen_empires_slave_target_4
					exists = event_target:human_fallen_empires_slave_target_5
				}
			}
			save_event_target_as = human_fallen_empires_slave_target_5
		}
	}
}

# this planet, from bombarder
human_fallen_empires_effect_pirate_ravage_planet = {
	solar_system = {
		every_fleet_in_system = {
			fleet_event = {
				id = human_fallen_empires_pirate.304
			}
		}
	}
	random_tile = {
		limit = {
			has_building = yes
			is_ruined = no
		}
		set_ruined = yes
		# протестить можно ли просто фром
		from = {
			add_minerals = 50
			add_energy = 10
			add_physics_research = 5
			add_society_research = 5
			add_engineering_research = 5
		}
	}
	if = {
		limit = {
			from = {
				any_owned_planet = {
					free_pop_tiles > 0
				}
			}
		}
		random_owned_pop = {
			limit = {
				is_growing = no
				is_sapient = yes
			}
			save_event_target_as = human_fallen_empires_settle_pop_target
		}
		from = {
			human_fallen_empires_effect_settle_pop = yes
		}
	}
	add_modifier = {
		modifier = human_fallen_empires_pirate_ravaged_planet
		days = @human_fallen_empires_pirate_ravaged_planet_time
	}
	owner = {
		if = {
			limit = {
				has_event_chain = human_fallen_empires_chain_pirate_count
				from = {
					is_country_type = human_fallen_empires_pirate
				}
			}
			add_event_chain_counter = {
				event_chain = human_fallen_empires_chain_pirate_count
				counter = human_fallen_empires_chain_pirate_count_planet_ravaged
				amount = 1
			}
		}
	}
}

human_fallen_empires_effect_pirate_resource_reward = {
	add_minerals = 90
	add_energy = 10
	add_physics_research = 5
	add_society_research = 5
	add_engineering_research = 5
}

human_fallen_empires_effect_pirate_attack_count_check = {
	if = {
		limit = {
			check_variable = {
				which = human_fallen_empires_pirate_attack_count
				value > 10
			}
		}
		set_variable = {
			which = human_fallen_empires_pirate_attack_count
			value = 0
		}
		random_country = {
			limit = {
				has_country_flag = human_fallen_empires_pirate_attack_count@prev
			}
			save_event_target_as = human_fallen_empires_pirate_country
		}
		country_event = {
			id = human_fallen_empires_pirate.200
			days = 1
			random = 30
		}
	}
}

# for country
human_fallen_empires_effect_pirate_flee_fleets = {
	random_country = {
		limit = {
			is_country_type = human_fallen_empires_pirate
			not = {
				is_country = prev
			}
		}
		prev = {
			every_owned_fleet = {
				limit = {
					is_ship_class = shipclass_military
				}
				set_owner = prevprev
				if = {
					limit = {
						prev = {
							not = {
								is_country_type = human_fallen_empires_pirate
							}
						}
					}
					log = "[this.GetName] flee to [owner.GetName] from [prev.GetName]"
				}
			}
		}
	}
}

# root fleet, this system
# human_fallen_empires_effect_pirate_path_get_next = {
# 	if = {
# 		limit = {
# 			has_hyperlane_to = root.solar_system
# 		}
# 		if = {
# 			limit = {
# 				human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
# 			}
# 			save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
# 		}
# 	}
# 	else = {
# 		root = {
# 			closest_system = {
# 				limit = {
# 					not = {
# 						has_star_flag = human_fallen_empires_pirate_fleet_system_check@root
# 					}
# 					has_hyperlane_to = prevprev
# 					human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
# 				}
# 				root = {
# 					log = "looping warning"
# 				}
# 				set_timed_star_flag = {
# 					flag = human_fallen_empires_pirate_fleet_system_check@root
# 					days = 1
# 				}
# 				human_fallen_empires_effect_pirate_path_get_next = yes
# 			}
# 		}
# 	}
# }

human_fallen_empires_effect_pirate_path_get_next = {
	if = {
		limit = {
			has_hyperlane_to = root.solar_system
		}
		if = {
			limit = {
				human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
			}
			save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
		}
	}
	else = {
		root = {
			closest_system = {
				limit = {
					not = {
						has_star_flag = human_fallen_empires_pirate_fleet_system_check@root
					}
					has_hyperlane_to = prevprev
					human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
				}
				max_steps = 10
				set_timed_star_flag = {
					flag = human_fallen_empires_pirate_fleet_system_check@root
					days = 1
				}
				if = {
					limit = {
						has_hyperlane_to = root.solar_system
					}
					if = {
						limit = {
							human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
						}
						save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
					}
				}
				else = {
					root = {
						closest_system = {
							limit = {
								not = {
									has_star_flag = human_fallen_empires_pirate_fleet_system_check@root
								}
								has_hyperlane_to = prevprev
								human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
							}
							max_steps = 9
							set_timed_star_flag = {
								flag = human_fallen_empires_pirate_fleet_system_check@root
								days = 1
							}
							if = {
								limit = {
									has_hyperlane_to = root.solar_system
								}
								if = {
									limit = {
										human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
									}
									save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
								}
							}
							else = {
								root = {
									closest_system = {
										limit = {
											not = {
												has_star_flag = human_fallen_empires_pirate_fleet_system_check@root
											}
											has_hyperlane_to = prevprev
											human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
										}
										max_steps = 8
										set_timed_star_flag = {
											flag = human_fallen_empires_pirate_fleet_system_check@root
											days = 1
										}
										if = {
											limit = {
												has_hyperlane_to = root.solar_system
											}
											if = {
												limit = {
													human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
												}
												save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
											}
										}
										else = {
											root = {
												closest_system = {
													limit = {
														not = {
															has_star_flag = human_fallen_empires_pirate_fleet_system_check@root
														}
														has_hyperlane_to = prevprev
														human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
													}
													max_steps = 7
													set_timed_star_flag = {
														flag = human_fallen_empires_pirate_fleet_system_check@root
														days = 1
													}
													if = {
														limit = {
															has_hyperlane_to = root.solar_system
														}
														if = {
															limit = {
																human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
															}
															save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
														}
													}
													else = {
														root = {
															closest_system = {
																limit = {
																	not = {
																		has_star_flag = human_fallen_empires_pirate_fleet_system_check@root
																	}
																	has_hyperlane_to = prevprev
																	human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
																}
																max_steps = 6
																set_timed_star_flag = {
																	flag = human_fallen_empires_pirate_fleet_system_check@root
																	days = 1
																}
																if = {
																	limit = {
																		has_hyperlane_to = root.solar_system
																	}
																	if = {
																		limit = {
																			human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
																		}
																		save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
																	}
																}
																else = {
																	root = {
																		closest_system = {
																			limit = {
																				not = {
																					has_star_flag = human_fallen_empires_pirate_fleet_system_check@root
																				}
																				has_hyperlane_to = prevprev
																				human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
																			}
																			max_steps = 5
																			set_timed_star_flag = {
																				flag = human_fallen_empires_pirate_fleet_system_check@root
																				days = 1
																			}
																			if = {
																				limit = {
																					has_hyperlane_to = root.solar_system
																				}
																				if = {
																					limit = {
																						human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
																					}
																					save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
																				}
																			}
																			else = {
																				root = {
																					closest_system = {
																						limit = {
																							not = {
																								has_star_flag = human_fallen_empires_pirate_fleet_system_check@root
																							}
																							has_hyperlane_to = prevprev
																							human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
																						}
																						max_steps = 4
																						set_timed_star_flag = {
																							flag = human_fallen_empires_pirate_fleet_system_check@root
																							days = 1
																						}
																						if = {
																							limit = {
																								has_hyperlane_to = root.solar_system
																							}
																							if = {
																								limit = {
																									human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
																								}
																								save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
																							}
																						}
																						else = {
																							root = {
																								closest_system = {
																									limit = {
																										not = {
																											has_star_flag = human_fallen_empires_pirate_fleet_system_check@root
																										}
																										has_hyperlane_to = prevprev
																										human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
																									}
																									max_steps = 4
																									set_timed_star_flag = {
																										flag = human_fallen_empires_pirate_fleet_system_check@root
																										days = 1
																									}
																									if = {
																										limit = {
																											has_hyperlane_to = root.solar_system
																										}
																										if = {
																											limit = {
																												human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
																											}
																											save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
																										}
																									}
																									else = {
																										root = {
																											closest_system = {
																												limit = {
																													not = {
																														has_star_flag = human_fallen_empires_pirate_fleet_system_check@root
																													}
																													has_hyperlane_to = prevprev
																													human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
																												}
																												max_steps = 3
																												set_timed_star_flag = {
																													flag = human_fallen_empires_pirate_fleet_system_check@root
																													days = 1
																												}
																												if = {
																													limit = {
																														has_hyperlane_to = root.solar_system
																													}
																													if = {
																														limit = {
																															human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
																														}
																														save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
																													}
																												}
																												else = {
																													root = {
																														closest_system = {
																															limit = {
																																not = {
																																	has_star_flag = human_fallen_empires_pirate_fleet_system_check@root
																																}
																																has_hyperlane_to = prevprev
																																human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
																															}
																															max_steps = 2
																															set_timed_star_flag = {
																																flag = human_fallen_empires_pirate_fleet_system_check@root
																																days = 1
																															}
																															if = {
																																limit = {
																																	has_hyperlane_to = root.solar_system
																																}
																																if = {
																																	limit = {
																																		human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
																																	}
																																	save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
																																}
																															}
																															else = {
																																root = {
																																	closest_system = {
																																		limit = {
																																			not = {
																																				has_star_flag = human_fallen_empires_pirate_fleet_system_check@root
																																			}
																																			has_hyperlane_to = prevprev
																																			human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
																																		}
																																		max_steps = 1
																																		set_timed_star_flag = {
																																			flag = human_fallen_empires_pirate_fleet_system_check@root
																																			days = 1
																																		}
																																		save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
																																	}
																																}
																															}
																														}
																													}
																												}
																											}
																										}
																									}
																								}
																							}
																						}
																					}
																				}
																			}
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
		}
	}
}

human_fallen_empires_effect_pirate_path_target_home = {
	if = {
		limit = {
			solar_system = {
				exists = owner
				owner = {
					not = {
						is_country = root.owner
					}
				}
			}
		}
		closest_system = {
			limit = {
				exists = owner
				owner = {
					is_country = root.owner
				}
				# heavy check to the end
				human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
				human_fallen_empires_trigger_pirate_path_check = yes
			}
			root = {
				set_timed_fleet_flag = {
					flag = human_fallen_empires_pirate_fleet_target_system@prev
					days = 365
				}
				set_timed_fleet_flag = {
					flag = human_fallen_empires_pirate_fleet_has_target
					days = 365
				}
			}
		}
	}
}

human_fallen_empires_effect_pirate_path_target_planet = {
	solar_system = {
		if = {
			limit = {
				exists = solar_system.starbase.owner
				exists = solar_system.starbase.fleet
				solar_system.starbase.owner = {
					is_hostile = root.owner
				}
				solar_system.starbase.fleet = {
					has_hp_percentage > 0.9
				}
			}
			root = {
				if = {
					limit = {
						has_fleet_flag = human_fallen_empires_pirate_log_fleet
					}
					log = "[this.GetName] will suppress starbase of [solar_system.GetName]"
				}
				set_fleet_flag = human_fallen_empires_pirate_fleet_move_to_target
				clear_fleet_actions = this
				queue_actions = {
					find_closest_planet = {
						trigger = {
							id = human_fallen_empires_pirate.trigger.0
							is_same_value = prevprev.system_star
						}
						found_planet = {
							move_to = this
						}
					}
				}
				# auto_move_to_planet = {
					# target = prev.system_star
					# clear_auto_move_on_arrival = yes
				# }
			}
		}
		if = {
			limit = {
				root = {
					not = {
						has_fleet_flag = human_fallen_empires_pirate_fleet_has_target
					}
				}
			}
			random_system_planet = {
				limit = {
					or = {
						and = {
							exists = controller
							controller = {
								is_hostile = root.owner
							}
							or = {
								has_mining_station = yes
								has_research_station = yes
							}
						}
						and = {
							exists = owner
							owner = {
								is_hostile = root.owner
							}
							not = {
								has_modifier = human_fallen_empires_pirate_ravaged_planet
							}
							#has_orbital_bombardment = no
						}
					}
				}
				weights = {
					base = 10
					modifier = {
						mult = 100
						not = {
							exists = owner
						}
					}
				}
				root = {
					if = {
						limit = {
							has_fleet_flag = human_fallen_empires_pirate_log_fleet
						}
						log = "[this.GetName] want to plunder [prev.GetName]"
					}
					set_fleet_flag = human_fallen_empires_pirate_fleet_move_to_target
					clear_fleet_actions = this
					queue_actions = {
						find_closest_planet = {
							trigger = {
								id = human_fallen_empires_pirate.trigger.1
								is_planet = prevprev
							}
							found_planet = {
								orbit_planet = this
								repeat = {
									while = {
										id = human_fallen_empires_pirate.trigger.1.1
										num_pops > 0
									}
									#wait = 30
									# lul
									#move_to = this
									orbit_planet = this
								}
							}
						}
					}
					# if = {
						# limit = {
							# prev = {
								# num_pops > 0
							# }
						# }
						# human_fallen_empires_effect_pirate_path_fleet_clear_actions = yes
						# auto_move_to_planet = {
							# target = prev
							# clear_auto_move_on_arrival = no
						# }
					# }
					# else = {
						# human_fallen_empires_effect_pirate_path_fleet_clear_actions = yes
						# auto_move_to_planet = {
							# target = prev
							# clear_auto_move_on_arrival = yes
						# }
					# }
				}
			}
		}
	}
}

human_fallen_empires_effect_pirate_path_target_system = {
	random_list = {
		# go home
		50 = {
			modifier = {
				factor = 0
				has_hp_percentage > 0.99
			}
			modifier = {
				factor = 2
				has_hp_percentage < 0.9
			}
			modifier = {
				factor = 2
				has_hp_percentage < 0.8
			}
			if = {
				limit = {
					has_fleet_flag = human_fallen_empires_pirate_log_fleet
				}
				log = "[this.GetName] in [solar_system.GetName] go home system"
			}
			human_fallen_empires_effect_pirate_path_target_home = yes
		}
		# move ahead
		100 = {
			modifier = {
				factor = 0
				or = {
					num_ships < 5
					has_hp_percentage < 0.7
				}
			}
			if = {
				limit = {
					has_fleet_flag = human_fallen_empires_pirate_log_fleet
				}
				log = "[this.GetName] in [solar_system.GetName] try to find system target"
			}
			closest_system = {
				limit = {
					exists = owner
					owner = {
						has_opinion_modifier = {
							who = root.owner
							modifier = human_fallen_empires_opinion_pirate_prior_target
						}
					}
					# heavy check to the end
					human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
					human_fallen_empires_trigger_pirate_path_check = yes
				}
				max_steps = 10
				root = {
					if = {
						limit = {
							has_fleet_flag = human_fallen_empires_pirate_log_fleet
						}
						log = "[this.GetName] in [solar_system.GetName] find prior target, it is [prev.GetName]"
					}
					set_timed_fleet_flag = {
						flag = human_fallen_empires_pirate_fleet_target_system@prev
						days = 365
					}
					set_timed_fleet_flag = {
						flag = human_fallen_empires_pirate_fleet_has_target
						days = 365
					}
				}
			}
			# try to find planet
			if = {
				limit = {
					not = {
						has_fleet_flag = human_fallen_empires_pirate_fleet_has_target
					}
				}
				closest_system = {
					limit = {
						#exists = owner
						any_planet = {
							exists = owner
							owner = {
								is_hostile = root.owner
							}
							num_pops > 0
							has_orbital_bombardment = no
						}
						# heavy check to the end
						human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
						human_fallen_empires_trigger_pirate_path_check = yes
					}
					max_steps = 10
					root = {
						if = {
							limit = {
								has_fleet_flag = human_fallen_empires_pirate_log_fleet
							}
							log = "[this.GetName] in [solar_system.GetName] find target with planet, it is [prev.GetName]"
						}
						set_timed_fleet_flag = {
							flag = human_fallen_empires_pirate_fleet_target_system@prev
							days = 365
						}
						set_timed_fleet_flag = {
							flag = human_fallen_empires_pirate_fleet_has_target
							days = 365
						}
					}
				}
			}
			if = {
				limit = {
					not = {
						has_fleet_flag = human_fallen_empires_pirate_fleet_has_target
					}
				}
				closest_system = {
					limit = {
						exists = owner
						any_planet = {
							exists = controller
							controller = {
								is_hostile = root.owner
							}
							or = {
								has_mining_station = yes
								has_research_station = yes
							}
						}
						# heavy check to the end
						human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
						human_fallen_empires_trigger_pirate_path_check = yes
					}
					max_steps = 10
					root = {
						if = {
							limit = {
								has_fleet_flag = human_fallen_empires_pirate_log_fleet
							}
							log = "[this.GetName] in [solar_system.GetName] find target with mining, it is [prev.GetName]"
						}
						set_timed_fleet_flag = {
							flag = human_fallen_empires_pirate_fleet_target_system@prev
							days = 365
						}
						set_timed_fleet_flag = {
							flag = human_fallen_empires_pirate_fleet_has_target
							days = 365
						}
					}
				}
			}
		}
	}
}

human_fallen_empires_effect_pirate_path_go_to_next = {
	if = {
		limit = {
			not = {
				has_fleet_flag = human_fallen_empires_pirate_fleet_move_to_target
			}
		}
		if = {
			limit = {
				not = {
					has_fleet_flag = human_fallen_empires_pirate_fleet_has_target
				}
			}
			human_fallen_empires_effect_pirate_path_target_system = yes
		}
		random_system = {
			limit = {
				root = {
					has_fleet_flag = human_fallen_empires_pirate_fleet_target_system@prev
				}
			}
			human_fallen_empires_effect_pirate_path_get_next = yes
			# closest_system = {
			# 	limit = {
			# 		has_hyperlane_to = root.solar_system
			# 		human_fallen_empires_trigger_pirate_fleet_power_in_system_check = yes
			# 	}
			# 	save_event_target_as = human_fallen_empires_pirate_fleet_target_system_next
			# }
		}
		if = {
			limit = {
				exists = event_target:human_fallen_empires_pirate_fleet_target_system_next
			}
			set_fleet_flag = human_fallen_empires_pirate_fleet_move_to_target
			if = {
				limit = {
					has_fleet_flag = human_fallen_empires_pirate_log_fleet
				}
				log = "[this.GetName] move to [human_fallen_empires_pirate_fleet_target_system_next.GetName]"
			}
			clear_fleet_actions = this
			queue_actions = {
				find_closest_system = {
					trigger = {
						id = human_fallen_empires_pirate.trigger.2
						is_same_value = event_target:human_fallen_empires_pirate_fleet_target_system_next
					}
					found_system = {
						move_to = this
					}
				}
			}
			# auto_move_to_planet = {
				# target = event_target:human_fallen_empires_pirate_fleet_target_system_next.system_star
				# clear_auto_move_on_arrival = yes
			# }
		}
		# next system not exists, remove target
		else = {
			if = {
				limit = {
					has_fleet_flag = human_fallen_empires_pirate_log_fleet
				}
				log = "[this.GetName] in [solar_system.GetName] target not find, wait 180 days"
			}
			human_fallen_empires_effect_pirate_path_fleet_reset = yes
			if = {
				limit = {
					not = {
						has_fleet_flag = human_fallen_empires_pirate_fleet_rest
					}
				}
				set_timed_fleet_flag = {
					flag = human_fallen_empires_pirate_fleet_rest
					days = 179
				}
				fleet_event = {
					id = human_fallen_empires_pirate.300
					days = 180
				}
			}
		}
	}
}

human_fallen_empires_effect_pirate_path_fleet_reset = {
	clear_fleet_actions = this
	remove_fleet_flag = human_fallen_empires_pirate_fleet_move_to_target
	remove_fleet_flag = human_fallen_empires_pirate_fleet_has_target
	random_system = {
		limit = {
			root = {
				has_fleet_flag = human_fallen_empires_pirate_fleet_target_system@prev
			}
		}
		root = {
			remove_fleet_flag = human_fallen_empires_pirate_fleet_target_system@prev
		}
	}
}
