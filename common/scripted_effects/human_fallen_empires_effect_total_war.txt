#

# total war cb, need 2 event targets
human_fallen_empires_effect_total_war_declare = {
	if = {
		limit = {
			not = {
				event_target:human_fallen_empires_total_war_attaker = {
					is_at_war_with = event_target:human_fallen_empires_total_war_defender
				}
			}
		}
		event_target:human_fallen_empires_total_war_attaker = {
			declare_war = {
				target = event_target:human_fallen_empires_total_war_defender
				#name = "NAME_Machine_Uprising_War"
				attacker_war_goal = human_fallen_empires_wg_total_war
			}
		}
	}
}

human_fallen_empires_effect_create_vassal = {
	add_threat = {
		who = root
		amount = 1 # scales to pops
	}
	if = {
		limit = {
			owner = {
				is_country = event_target:WarInHeavenLoserFE
			}
		}
		save_event_target_as = human_fallen_empires_planet
		if = {
			limit = {
				any_country = {
					has_country_flag = human_fallen_empires_liberated_country
					num_owned_planets < 4
				}
			}
			random_country = {
				limit = {
					has_country_flag = human_fallen_empires_liberated_country
					num_owned_planets < 4
				}
				event_target:human_fallen_empires_planet = {
					set_owner = prev
					set_controller = prev
				}
			}
			else = {
				create_country = {
					name = random
					authority = random
					civics = random
					released_by_country = root
					released_from_country = event_target:WarInHeavenLoserFE
					species = event_target:WarInHeavenLoserFE.species
					ethos = root
					flag = random
					type = default
					day_zero_contact = no
					effect = {
						set_timed_country_flag = {
							flag = human_fallen_empires_liberated_country days = 1
						}
						establish_communications_no_message = root
						#establish_communications_no_message = fromfromfrom
						#establish_communications_no_message = parameter:planet.owner
						establish_contact = {
							who = root location = event_target:human_fallen_empires_planet
						}
						#establish_contact = { who = fromfromfrom location = parameter:planet }
						#establish_contact = { who = parameter:planet.owner location = parameter:planet }
						event_target:human_fallen_empires_planet = {
							set_owner = prev
							set_controller = prev
							solar_system = {
								every_system_planet = {
									limit = {
										exists = owner
										owner = {
											is_country = event_target:WarInHeavenLoserFE
										}
									}
									set_owner = prevprevprev
									set_controller = prevprevprev
								}
							}
						}
						if = {
							limit = {
								is_country_type = awakened_fallen_empire
							}
							if = {
								limit = {
									has_ethic = ethic_fanatic_spiritualist
								}
								set_subject_of = {
									who = root
									subject_type = dominion
								}
								else = {
									if = {
										limit = {
											has_ethic = ethic_fanatic_xenophile
										}
										set_subject_of = {
											who = root
											subject_type = signatory
										}
									}
								}
							}
							else = {
								if = {
									limit = {
										has_country_flag = human_fallen_empires_coalition_leader
									}
									set_subject_of = {
										who = root
										subject_type = human_fallen_empires_future_vassal
									}
									#country_remove_ethic = ethic_fanatic_militarist
									#country_add_ethic = ethic_militarist
									else = {
										set_subject_of = {
											who = root
											subject_type = vassal
										}
									}
								}
							}
						}
					}
				}
			}
		}
	}
}

# for country
human_fallen_empires_effect_split_planets = {
	every_country = {
		limit = {
			or = {
				is_in_federation_with = event_target:WarInHeavenLoserFE
				and = {
					exists = overlord
					overlord = {
						is_country = event_target:WarInHeavenLoserFE
					}
				}
			}
		}
		remove_modifier = human_fallen_empires_fallen_resurces_drain
		set_timed_country_flag = {
			flag = war_in_heaven_loser
			days = 1
		}
	}
	every_country = {
		limit = {
			or = {
				is_in_federation_with = event_target:WarInHeavenWinnerFE
				and = {
					exists = overlord
					overlord = {
						is_country = event_target:WarInHeavenWinnerFE
					}
				}
			}
		}
		remove_modifier = human_fallen_empires_fallen_resurces_drain
		set_timed_country_flag = {
			flag = war_in_heaven_loser
			days = 1
		}
	}
	# Losers are punished, planets are given to nearby winners
	if = {
		limit = {
			any_relation = {
				has_country_flag = war_in_heaven_winner
			}
			any_relation = {
				has_country_flag = war_in_heaven_loser
			}
		}
		every_planet = {
			limit = {
				exists = owner
				owner = {
					has_country_flag = war_in_heaven_loser
				}
				is_capital = no
			}
			save_event_target_as = planet_to_cede
			# First dibs to countries who originally sided with them
			random_country = {
				limit = {
					has_country_flag = war_in_heaven_winner
					event_target:planet_to_cede = {
						is_neighbor_of = prev
					}
				}
				if = {
					limit = {
						has_country_flag = war_in_heaven_picked_side
					}
					save_event_target_as = conqueror
					event_target:planet_to_cede = {
						owner = {
							set_country_flag = war_in_heaven_planet_was_taken
						}
						conquer = event_target:conqueror
						set_owner = event_target:conqueror
					}
					set_country_flag = war_in_heaven_planet_was_given
					# May decide to be nice to a late joiner
					else = {
						random = {
							chance = 30
							save_event_target_as = conqueror
							event_target:planet_to_cede = {
								owner = {
									set_country_flag = war_in_heaven_planet_was_taken
								}
								conquer = event_target:conqueror
								set_owner = event_target:conqueror
							}
							set_country_flag = war_in_heaven_planet_was_given
						}
					}
				}
			}
		}
	}
	# Add opinions towards winner
	every_country = {
		limit = {
			has_country_flag = war_in_heaven_winner
		}
		add_opinion_modifier = {
			who = event_target:WarInHeavenWinnerFE
			modifier = opinion_war_in_heaven_winner
		}
		event_target:WarInHeavenWinnerFE = {
			add_opinion_modifier = {
				who = prev
				modifier = opinion_war_in_heaven_winner
			}
		}
	}
	every_country = {
		limit = {
			has_country_flag = war_in_heaven_loser
		}
		remove_opinion_modifier = {
			who = event_target:WarInHeavenWinnerFE
			modifier = opinion_war_in_heaven_enemy
		}
		event_target:WarInHeavenWinnerFE = {
			remove_opinion_modifier = {
				who = prev
				modifier = opinion_war_in_heaven_enemy
			}
		}
	}
	# War in Heaven victory event
	if = {
		limit = {
			event_target:WarInHeavenWinnerFE = {
				is_at_war = no
				human_fallen_empires_trigger_is_regular_fallen = yes
			}
		}
		# every_country = {
			# limit = {
				# is_ai = no
			# }
			# country_event = {
				# id = war_in_heaven.5
			# }
			# country_event = {
				# id = war_in_heaven.6
			# }
			# country_event = {
				# id = war_in_heaven.7
			# }
			# country_event = {
				# id = war_in_heaven.8
			# }
			# country_event = {
				# id = war_in_heaven.9
			# }
		# }
	}
	# Cleanup
	every_country = {
		limit = {
			OR = {
				has_country_flag = war_in_heaven_loser
				has_country_flag = war_in_heaven_winner
			}
		}
		remove_country_flag = war_in_heaven_winner
		remove_country_flag = war_in_heaven_loser
		remove_country_flag = war_in_heaven_planet_was_given
		remove_country_flag = war_in_heaven_planet_was_taken
	}
}