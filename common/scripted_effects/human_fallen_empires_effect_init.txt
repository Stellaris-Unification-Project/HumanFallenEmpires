#

# for default country, give tier tech
human_fallen_empires_effect_init_give_tech_t1 = {
	if = {
		limit = {
			exists = event_target:human_fallen_empires_init_placeholder_t1_tech
		}		
		copy_techs_from = {
			target = event_target:human_fallen_empires_init_placeholder_t1_tech
			except = {
			}
		}
	}
	else = {
		create_country = {
			type = human_fallen_empires_placeholder_t1_tech
			ignore_initial_colony_error = yes
			effect = {
				save_global_event_target_as = human_fallen_empires_init_placeholder_t1_tech
			}
		}
		human_fallen_empires_effect_init_give_tech_t1 = yes
	}
}

human_fallen_empires_effect_init_give_tech_t2 = {
	if = {
		limit = {
			exists = event_target:human_fallen_empires_init_placeholder_t2_tech
		}		
		copy_techs_from = {
			target = event_target:human_fallen_empires_init_placeholder_t2_tech
			except = {
			}
		}
	}
	else = {
		create_country = {
			type = human_fallen_empires_placeholder_t2_tech
			ignore_initial_colony_error = yes
			effect = {
				save_global_event_target_as = human_fallen_empires_init_placeholder_t2_tech
			}
		}
		human_fallen_empires_effect_init_give_tech_t2 = yes
	}
}

human_fallen_empires_effect_init_give_tech_t3 = {
	if = {
		limit = {
			exists = event_target:human_fallen_empires_init_placeholder_t3_tech
		}		
		copy_techs_from = {
			target = event_target:human_fallen_empires_init_placeholder_t3_tech
			except = {
			}
		}
	}
	else = {
		create_country = {
			type = human_fallen_empires_placeholder_t3_tech
			ignore_initial_colony_error = yes
			effect = {
				save_global_event_target_as = human_fallen_empires_init_placeholder_t3_tech
			}
		}
		human_fallen_empires_effect_init_give_tech_t3 = yes
	}
}

human_fallen_empires_effect_init_give_tech_t4 = {
	if = {
		limit = {
			exists = event_target:human_fallen_empires_init_placeholder_t4_tech
		}		
		copy_techs_from = {
			target = event_target:human_fallen_empires_init_placeholder_t4_tech
			except = {
			}
		}
	}
	else = {
		create_country = {
			type = human_fallen_empires_placeholder_t4_tech
			ignore_initial_colony_error = yes
			effect = {
				save_global_event_target_as = human_fallen_empires_init_placeholder_t4_tech
			}
		}
		human_fallen_empires_effect_init_give_tech_t4 = yes
	}
}

human_fallen_empires_effect_init_give_tech_t5 = {
	if = {
		limit = {
			exists = event_target:human_fallen_empires_init_placeholder_t5_tech
		}		
		copy_techs_from = {
			target = event_target:human_fallen_empires_init_placeholder_t5_tech
			except = {
			}
		}
	}
	else = {
		create_country = {
			type = human_fallen_empires_placeholder_t5_tech
			ignore_initial_colony_error = yes
			effect = {
				save_global_event_target_as = human_fallen_empires_init_placeholder_t5_tech
			}
		}
		human_fallen_empires_effect_init_give_tech_t5 = yes
	}
}

# for country make colony, need human_fallen_empires_init_target
human_fallen_empires_effect_init_make_colony = {
	event_target:human_fallen_empires_init_target.capital_scope = {
		closest_system = {
			limit = {
				or = {
					and = {
						exists = space_owner
						space_owner = {
							is_country = event_target:human_fallen_empires_init_target
						}
					}
					has_presence = no
				}
				any_planet = {
					habitability = {
						who = event_target:human_fallen_empires_init_target.species
						value > 0.2
					}
					not = {
						exists = owner
					}
				}
			}
			random_system_planet = {
				limit = {
					habitability = {
						who = event_target:human_fallen_empires_init_target.species
						value > 0.2
					}
					not = {
						exists = owner
					}
				}
				create_colony = {
					owner = event_target:human_fallen_empires_init_target
					species = owner
				}
				if = {
					limit = {
						not = {
							exists = owner
						}
					}
					log = "owner not exists on [this.GetName]"
				}
			}
		}
	}
}

human_fallen_empires_effect_init_develop_planet = {
	human_fallen_empires_effect_init_clear_blockers = yes
	# remove low tier buildings from capital
	every_tile = {
		limit = {
			or = {
				autobuild_trigger_has_any_regular_building = yes
				autobuild_trigger_has_planet_capital_or_shelter = yes
			}
		}
		remove_building = yes
	}
	# set buildings
	if = {
		limit = {
			any_tile = {
				or = {
					autobuild_trigger_tile_has_energy_more_than_others = yes
					has_deposit = no
				}
				num_adjacent_tiles > 3
			}
		}
		random_tile = {
			limit = {
				or = {
					autobuild_trigger_tile_has_energy_more_than_others = yes
					has_deposit = no
				}
				num_adjacent_tiles > 3
			}
			remove_blocker = yes
			human_fallen_empires_effect_init_set_capital = yes
		}
	}
	else = {
		random_tile = {
			limit = {
				or = {
					autobuild_trigger_tile_has_energy_more_than_others = yes
					has_deposit = no
				}
				num_adjacent_tiles > 2
			}
			remove_blocker = yes
			human_fallen_empires_effect_init_set_capital = yes
		}
	}
	every_tile = {
		limit = {
			has_deposit = yes
			has_building = no
		}
		if = {
			limit = {
				autobuild_trigger_tile_has_science_more_than_others = yes
			}
			human_fallen_empires_effect_init_set_lab = yes
		}
		else_if = {
			limit = {
				autobuild_trigger_tile_has_energy_more_than_others = yes
			}
			human_fallen_empires_effect_init_set_power_plant = yes
		}
		else_if = {
			limit = {
				autobuild_trigger_tile_has_minerals_more_than_others = yes
			}
			human_fallen_empires_effect_init_set_mine = yes
		}
		else_if = {
			limit = {
				autobuild_trigger_tile_has_food_more_than_others = yes
			}
			if = {
				limit = {
					owner = {
						has_authority = auth_machine_intelligence
					}
				}
				human_fallen_empires_effect_init_set_power_plant = yes
			}
			else = {
				human_fallen_empires_effect_init_set_farm = yes
			}
		}
	}
	human_fallen_empires_effect_init_set_pops = yes
	human_fallen_empires_effect_init_set_starbase = yes
}

human_fallen_empires_effect_init_clear_blockers = {
	every_tile = {
		limit = {
			has_deposit = yes
			has_blocker = yes
		}
		remove_blocker = yes
	}
}

human_fallen_empires_effect_init_set_pops = {
	every_tile = {
		limit = {
			has_building = yes
			not = { exists = pop }
		}
		remove_blocker = yes
		create_pop = {
			species = owner
		}
	}
	human_fallen_empires_effect_brainworm_set_free_pop_with_reservation = yes
}

human_fallen_empires_effect_init_set_capital = {
	if = {
		limit = {
			owner = {
				has_technology = tech_galactic_administration
			}
			root = {
				is_capital = yes
			}
		}
		set_building = building_capital_3
	}
	else_if = {
		limit = {
			owner = {
				has_technology = tech_colonial_centralization
			}
		}
		set_building = building_capital_2
	}
	else = {
		set_building = building_capital_1
	}
}

human_fallen_empires_effect_init_set_lab = {
	if = {
		limit = {
			has_resource = physics_research
		}
		owner = {
			switch = {
				trigger = has_technology
				tech_physics_lab_3 = {
					prev = {
						if = {
						 	limit = {
						 		root = {
						 			is_capital = yes
						 		}
						 	}
							set_building = building_physics_lab_4
							else = {
								set_building = building_physics_lab_3
							}
						}
					}
				}
				tech_physics_lab_2 = {
					prev = {
						set_building = building_physics_lab_2
					}
				}
				tech_physics_lab_1 = {
					prev = {
						set_building = building_physics_lab_1
					}
				}
			}
		}
	}
	else_if = {
		limit = {
			has_resource = society_research
		}
		owner = {
			switch = {
				trigger = has_technology
				tech_biolab_3 = {
					prev = {
						if = {
							limit = {
								root = {
									is_capital = yes
								}
							}
							set_building = building_biolab_4
							else = {
								set_building = building_biolab_3
							}
						}
					}
				}
				tech_biolab_2 = {
					prev = {
						set_building = building_biolab_2
					}
				}
				tech_biolab_1 = {
					prev = {
						set_building = building_biolab_1
					}
				}
			}
		}
	}
	else_if = {
		limit = {
			has_resource = engineering_research
		}
		owner = {
			switch = {
				trigger = has_technology
				tech_engineering_lab_3 = {
					prev = {
						if = {
							limit = {
								root = {
									is_capital = yes
								}
							}
							set_building = building_engineering_facility_4
							else = {
								set_building = building_engineering_facility_3
							}
						}
					}
				}
				tech_engineering_lab_2 = {
					prev = {
						set_building = building_engineering_facility_2
					}
				}
				tech_engineering_lab_1 = {
					prev = {
						set_building = building_engineering_facility_1
					}
				}
			}
		}
	}
}

human_fallen_empires_effect_init_set_power_plant = {
	owner = {
		switch = {
			trigger = has_technology
			tech_power_plant_4 = {
				prev = {
					if = {
						limit = {
						 	root = {
						 		is_capital = yes
						 	}
						}
						set_building = building_power_plant_5
					}
					else = {
						set_building = building_power_plant_4
					}
				}
			}
			tech_power_plant_3 = {
				prev = {
					set_building = building_power_plant_3
				}
			}
			tech_power_plant_2 = {
				prev = {
					set_building = building_power_plant_2
				}
			}
			tech_power_plant_1 = {
				prev = {
					set_building = building_power_plant_1
				}
			}
		}
	}
}

human_fallen_empires_effect_init_set_mine = {
	owner = {
		switch = {
			trigger = has_technology
			tech_mining_network_4 = {
				prev = {
					if = {
						limit = {
						 	root = {
						 		is_capital = yes
						 	}
						}
						set_building = building_mining_network_5
					}
					else = {
						set_building = building_mining_network_4
					}
				}
			}
			tech_mining_network_3 = {
				prev = {
					set_building = building_mining_network_3
				}
			}
			tech_mining_network_2 = {
				prev = {
					set_building = building_mining_network_2
				}
			}
			tech_basic_industry = {
				prev = {
					set_building = building_mining_network_1
				}
			}
		}
	}
}

human_fallen_empires_effect_init_set_farm = {
	owner = {
		switch = {
			trigger = has_technology
			tech_nano_vitality_crops = {
				prev = {
					if = {
						limit = {
						 	root = {
						 		is_capital = yes
						 	}
						}
						set_building = building_hydroponics_farm_5
					}
					else = {
						set_building = building_hydroponics_farm_4
					}
				}
			}
			tech_gene_crops = {
				prev = {
					set_building = building_hydroponics_farm_3
				}
			}
			tech_hydroponics = {
				prev = {
					set_building = building_hydroponics_farm_2
				}
			}
			tech_eco_simulation = {
				prev = {
					set_building = building_hydroponics_farm_1
				}
			}
		}
	}
}

human_fallen_empires_effect_init_set_starbase = {
	human_fallen_empires_effect_create_starbase_outpost_from_planet = yes
	starbase = {
		human_fallen_empires_effect_create_starbase_upgrade = yes
	}
}

# for country
human_fallen_empires_effect_init_set_minings_stations = {
	every_system_within_border = {
		every_system_planet = {
			limit = {
				not = {
					exists = owner
				}
				has_orbital_station = no
				or = {
					has_deposit_for = shipclass_mining_station
					has_deposit_for = shipclass_research_station
				}
			}
			if = {
				limit = {
					has_deposit_for = shipclass_mining_station
				}
				create_mining_station = {
					owner = prevprevprev
				}
			}
			else = {
				create_research_station = {
					owner = prevprevprev
				}
			}
		}
	}
}

human_fallen_empires_effect_init_expand_borders = {
	save_event_target_as = human_fallen_empires_starbase_owner
	every_system_within_border = {
		every_neighbor_system = {
			limit = {
				not = { exists = owner }
				has_presence = no
			}
			ignore_hyperlanes = no
			human_fallen_empires_effect_create_starbase = yes
		}
	}
}

human_fallen_empires_effect_init_make_fleet = {
	create_fleet_from_naval_cap = 0.2
	# create admiral?
}
