#This rule is a condition for bombarding planets
#Root = fleet, potential attacker
#From = planet, potential target
can_orbital_bombard = {
	exists = FROM.OWNER
	or = {
		and = {
			ROOT.OWNER = {
				NOT = { has_communications = FROM.OWNER }
			}
			FROM.OWNER = {
				NOT = { is_country_type = primitive }
			}
		}
		and = {
			ROOT.OWNER = {
				Nor = {
					has_policy_flag = interference_passive
					has_policy_flag = interference_active
				}
			}
			FROM.OWNER = { is_country_type = primitive }
		}
		ROOT.OWNER = { is_at_war_with = FROM.CONTROLLER }
		FROM = { is_planet_class = pc_infested }
		FROM.CONTROLLER = {
			OR = {
				is_country_type = swarm
				is_country_type = ai_empire
				is_country_type = cybrex_empire
			}
		}
		ROOT.OWNER = {
			or = {
				is_country_type = extradimensional
				is_country_type = extradimensional_2
				is_country_type = extradimensional_3
				is_country_type = swarm
				is_country_type = ai_empire
				is_country_type = cybrex_empire
				# mod
				is_country_type = human_fallen_empires_pirate
				is_country_type = human_fallen_empires_drone
			}
		}
	}
}

#Root = country
#This = pop
#also evaluates true if pop_can_live_planet is false on current planet
can_auto_migrate_pop = {
	exists = root
	exists = planet
	exists = tile
	# brainworm
	tile = {
		nor = {
			has_building = human_fallen_empires_brainworm_reservation_0
			has_building = human_fallen_empires_brainworm_reservation_1
		}
	}
	# plague
	nand = {
		root = {
			has_country_edict = human_fallen_empires_plague_quarantine
		}
		planet = {
			has_planet_flag = human_fallen_empires_plague_planet
		}
	}
	# migration
	planet = {
		not = {
			has_modifier = human_fallen_empires_population_ban_auto_migrate
		}
	}
	root = {
		is_country_type = default
	}
	is_sapient = yes
	# проверить
	or = {
		is_enslaved = no
		and = {
			has_citizenship_type = {
				type = citizenship_caste_system
				country = root
			}
			root = {
				has_country_edict = human_fallen_empires_population_allow_for_caste
			}
		}
	}
	is_being_purged = no
	has_migration_control = no
	is_robot_pop = no
	NOT = { has_trait = trait_self_modified }
	NOT = { has_modifier = recently_migrated }
	NOT = { has_modifier = recent_refugee }
}

#Root = planet
#This = pop
pop_can_live_on_planet = {
	# or = {
	# 	exists = owner
	# 	is_sapient = no
	# }
	nand = {
		has_citizenship_type = { type = citizenship_purge }
		has_purge_type = { type = purge_displacement }
	}
	or = {
		root = {
			not = {
				habitability = {
					who = prev
					value < 0.2
				}
			}
		}
		is_robot_pop = yes
		and = {
			exists = owner
			owner = {
				not = {
					is_country_type = default
				}
			}
		}
	}
	or = {
		# everyone may live in sectors
		root = {
			sector_controlled = yes
		}
		# citizens may always live in core worlds
		or = {
			has_citizenship_type = { type = citizenship_full }
			has_citizenship_type = { type = citizenship_caste_system }
			has_citizenship_type = { type = citizenship_full_machine }
			has_citizenship_type = { type = citizenship_organic_trophy }
		}
		# core_worlds_all / hive minds let everyone live in core worlds
		and = {
			exists = owner
			or = {
				owner = { has_policy_flag = core_worlds_all }
				owner = { has_ethic = ethic_gestalt_consciousness }
				owner = {
					not = {
						is_country_type = default
					}
				}
			}
		}
		# core_worlds_citizens_and_slaves lets slaves live in core worlds
		and = {
			has_citizenship_type = { type = citizenship_slavery }
			exists = owner
			owner = { has_policy_flag = core_worlds_citizens_and_slaves }
		}
		# stop non-citizens from moving to planets with recent land appropriation
		NAND = {
			root = { has_modifier = land_appropriation }
			planet = { NOT = { is_same_value = root } }
 		}
	}
	# migration
	nor = {
		and = {
			root = {
				has_modifier = human_fallen_empires_population_yellow_ring
			}
			human_fallen_empires_trigger_is_thrifty = no
		}
		and = {
			root = {
				has_modifier = human_fallen_empires_population_red_ring
			}
			human_fallen_empires_trigger_is_industrious = no
		}
		and = {
			root = {
				has_modifier = human_fallen_empires_population_green_ring
			}
			human_fallen_empires_trigger_is_agrarian = no
		}
		and = {
			root = {
				has_modifier = human_fallen_empires_population_blue_ring
			}
			human_fallen_empires_trigger_is_clever = no
		}
		and = {
			root = {
				has_modifier = human_fallen_empires_population_grey_ring
			}
			human_fallen_empires_trigger_is_synthetic = no
		}
		and = {
			root = {
				has_modifier = human_fallen_empires_population_ban_auto_migrate
			}
			planet = {
				not = {
					is_planet = root
				}
			}
		}
	}
}

#Root = country
#This = pop
can_colonize_with_pop = {
	has_colonization_control = no
	NOT = { has_trait = trait_self_modified }
	if = {
		limit = {
			OR = {
				has_culture_shock = yes
				is_sapient = no
				# mod
				has_pop_flag = human_fallen_empires_plague_pop
				#human_fallen_empires_trigger_is_brainworm = yes
			}
		}
		custom_tooltip = {
			always = no
		}
		else = {
			always = yes
		}
	}
}

# Determines if notification messages should be sent after a ground combat
# this: planet
# from: winner
# root: loser
# show_notification_for_ground_combat = {
# 	NOT = {
# 		has_planet_flag = slave_revolt
# 		has_planet_flag = revolt_in_progress
# 		has_planet_flag = human_fallen_empires_plague_planet
# 	}
# }

# Checks if a pop can procreate
# This = Pop
can_pop_procreate = {
	is_sapient = yes
	is_being_purged = no
	has_culture_shock = no
	pop_can_reproduce = yes
	exists = planet
	OR = {
		planet = { NOT = { has_modifier = land_appropriation } }
		has_citizenship_rights = yes
	}
	# mod
	human_fallen_empires_trigger_is_brainworm = no
	not = {
		has_trait = human_fallen_empires_species_trait_infertil
	}
	or = {
		planet = {
			has_modifier = human_fallen_empires_population_birthcontrol_free
		}
		has_population_control = no
	}
	not = {
		planet = {
			has_modifier = human_fallen_empires_population_birthcontrol
		}
	}
}
